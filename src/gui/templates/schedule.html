<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление расписанием - Video Uploader</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-100">
    <div x-data="scheduleManager()" x-init="init()" class="min-h-screen">
        
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center">
                        <i class="fas fa-calendar-alt text-2xl text-blue-600 mr-3"></i>
                        <h1 class="text-2xl font-bold text-gray-900">Управление расписанием</h1>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <button @click="showCreateForm = true" 
                                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-plus mr-2"></i>Создать расписание
                        </button>
                        <button @click="refreshData()" 
                                class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                            <i class="fas fa-sync-alt mr-2"></i>Обновить
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-calendar-check text-2xl text-green-600"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Активных расписаний</dt>
                                <dd class="text-lg font-medium text-gray-900" x-text="stats.enabled_schedules || 0"></dd>
                            </dl>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-video text-2xl text-blue-600"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Использовано видео</dt>
                                <dd class="text-lg font-medium text-gray-900" x-text="stats.used_videos || 0"></dd>
                            </dl>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-file-alt text-2xl text-purple-600"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Использовано названий</dt>
                                <dd class="text-lg font-medium text-gray-900" x-text="stats.used_titles || 0"></dd>
                            </dl>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-clock text-2xl text-orange-600"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Следующая загрузка</dt>
                                <dd class="text-sm font-medium text-gray-900" x-text="nextUpload || 'Не запланировано'"></dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Schedules List -->
            <div class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-medium text-gray-900">
                        <i class="fas fa-list mr-2"></i>Расписания загрузок
                    </h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Название</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Платформа</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Время</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Дни недели</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Статус</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Действия</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="schedule in schedules" :key="schedule.id">
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-900" x-text="schedule.name"></div>
                                        <div class="text-sm text-gray-500">Макс. видео/день: <span x-text="schedule.max_videos_per_day"></span></div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                              :class="schedule.platform === 'tiktok' ? 'bg-pink-100 text-pink-800' : 'bg-purple-100 text-purple-800'"
                                              x-text="schedule.platform.charAt(0).toUpperCase() + schedule.platform.slice(1)">
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                        <div x-text="schedule.upload_times.join(', ')"></div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <div x-text="formatDaysOfWeek(schedule.days_of_week)"></div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                              :class="schedule.enabled ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
                                            <span x-text="schedule.enabled ? 'Активно' : 'Отключено'"></span>
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                        <button @click="toggleSchedule(schedule.id)" 
                                                :class="schedule.enabled ? 'text-red-600 hover:text-red-900' : 'text-green-600 hover:text-green-900'"
                                                x-text="schedule.enabled ? 'Отключить' : 'Включить'">
                                        </button>
                                        <button @click="editSchedule(schedule)" 
                                                class="text-blue-600 hover:text-blue-900">Изменить</button>
                                        <button @click="deleteSchedule(schedule.id)" 
                                                class="text-red-600 hover:text-red-900">Удалить</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

        </main>

        <!-- Create/Edit Schedule Modal -->
        <div x-show="showCreateForm || editingSchedule" 
             class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50"
             x-transition:enter="ease-out duration-300"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             x-transition:leave="ease-in duration-200"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0">
            
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">
                        <span x-show="!editingSchedule">Создать новое расписание</span>
                        <span x-show="editingSchedule">Редактировать расписание</span>
                    </h3>
                    <button @click="closeModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <form @submit.prevent="saveSchedule()">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700">Название расписания</label>
                            <input type="text" x-model="scheduleForm.name" required
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                   placeholder="Например: Ежедневная загрузка в 18:00">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700">Платформа</label>
                            <select x-model="scheduleForm.platform"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option value="tiktok">TikTok</option>
                                <option value="instagram">Instagram</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700">Тип расписания</label>
                            <select x-model="scheduleForm.schedule_type"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option value="daily">Ежедневно</option>
                                <option value="weekly">Еженедельно</option>
                                <option value="custom">Произвольное</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700">Время загрузки</label>
                            <input type="text" x-model="scheduleForm.upload_times_str" required
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                   placeholder="09:00, 15:00, 21:00">
                            <p class="text-xs text-gray-500 mt-1">Указывайте время через запятую в формате ЧЧ:ММ</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700">Максимум видео в день</label>
                            <input type="number" x-model="scheduleForm.max_videos_per_day" min="1" max="50"
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Дни недели</label>
                            <div class="grid grid-cols-7 gap-2">
                                <template x-for="(day, index) in daysOfWeek" :key="index">
                                    <label class="flex items-center justify-center p-2 border rounded-md cursor-pointer"
                                           :class="scheduleForm.days_of_week.includes(index) ? 'bg-blue-50 border-blue-500' : 'border-gray-300'">
                                        <input type="checkbox" 
                                               :checked="scheduleForm.days_of_week.includes(index)"
                                               @change="toggleDay(index)"
                                               class="sr-only">
                                        <span class="text-sm font-medium" x-text="day"></span>
                                    </label>
                                </template>
                            </div>
                        </div>

                        <div class="md:col-span-2">
                            <div class="flex items-center space-x-4">
                                <label class="flex items-center">
                                    <input type="checkbox" x-model="scheduleForm.auto_select_video" 
                                           class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="ml-2 text-sm text-gray-700">Автоматически выбирать видео</span>
                                </label>
                                
                                <label class="flex items-center">
                                    <input type="checkbox" x-model="scheduleForm.auto_select_title" 
                                           class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="ml-2 text-sm text-gray-700">Использовать названия из titles.txt</span>
                                </label>
                            </div>
                        </div>

                    </div>

                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" @click="closeModal()" 
                                class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors">
                            Отмена
                        </button>
                        <button type="submit" 
                                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            <span x-show="!editingSchedule">Создать</span>
                            <span x-show="editingSchedule">Сохранить</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Toast Notifications -->
        <div class="fixed bottom-4 right-4 space-y-2" x-show="notifications.length > 0">
            <template x-for="(notification, index) in notifications" :key="index">
                <div class="bg-white rounded-lg shadow-lg p-4 max-w-sm transform transition-all duration-300"
                     :class="notification.type === 'success' ? 'border-l-4 border-green-500' : 'border-l-4 border-red-500'"
                     x-show="notification.show">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i :class="notification.type === 'success' ? 'fas fa-check-circle text-green-500' : 'fas fa-exclamation-circle text-red-500'"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-gray-900" x-text="notification.title"></p>
                            <p class="text-sm text-gray-500" x-text="notification.message"></p>
                        </div>
                        <div class="ml-auto pl-3">
                            <button @click="removeNotification(index)" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <script>
        function scheduleManager() {
            return {
                schedules: [],
                stats: {},
                nextUpload: null,
                showCreateForm: false,
                editingSchedule: null,
                notifications: [],
                daysOfWeek: ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'],
                
                scheduleForm: {
                    name: '',
                    platform: 'tiktok',
                    schedule_type: 'daily',
                    upload_times_str: '18:00',
                    days_of_week: [0, 1, 2, 3, 4, 5, 6], // Все дни
                    max_videos_per_day: 5,
                    auto_select_video: true,
                    auto_select_title: true
                },

                init() {
                    this.refreshData();
                    setInterval(() => this.refreshData(), 30000); // Обновляем каждые 30 секунд
                },

                async refreshData() {
                    try {
                        const [schedulesResponse, statsResponse] = await Promise.all([
                            fetch('/api/schedules'),
                            fetch('/api/schedule-stats')
                        ]);
                        
                        this.schedules = await schedulesResponse.json();
                        this.stats = await statsResponse.json();
                        
                        this.calculateNextUpload();
                    } catch (error) {
                        console.error('Failed to refresh data:', error);
                    }
                },

                calculateNextUpload() {
                    // Простая логика расчета следующей загрузки
                    const now = new Date();
                    let nextTime = null;
                    
                    for (const schedule of this.schedules) {
                        if (!schedule.enabled) continue;
                        
                        for (const timeStr of schedule.upload_times) {
                            const [hours, minutes] = timeStr.split(':').map(Number);
                            const uploadTime = new Date();
                            uploadTime.setHours(hours, minutes, 0, 0);
                            
                            if (uploadTime < now) {
                                uploadTime.setDate(uploadTime.getDate() + 1);
                            }
                            
                            if (!nextTime || uploadTime < nextTime) {
                                nextTime = uploadTime;
                            }
                        }
                    }
                    
                    this.nextUpload = nextTime ? nextTime.toLocaleString('ru-RU') : null;
                },

                async saveSchedule() {
                    const upload_times = this.scheduleForm.upload_times_str
                        .split(',')
                        .map(t => t.trim())
                        .filter(t => t.match(/^\d{2}:\d{2}$/));
                    
                    if (upload_times.length === 0) {
                        this.showNotification('error', 'Ошибка', 'Укажите корректное время в формате ЧЧ:ММ');
                        return;
                    }
                    
                    const formData = {
                        name: this.scheduleForm.name,
                        platform: this.scheduleForm.platform,
                        schedule_type: this.scheduleForm.schedule_type,
                        upload_times: upload_times,
                        days_of_week: this.scheduleForm.days_of_week,
                        max_videos_per_day: this.scheduleForm.max_videos_per_day,
                        auto_select_video: this.scheduleForm.auto_select_video,
                        auto_select_title: this.scheduleForm.auto_select_title
                    };
                    
                    try {
                        let response;
                        if (this.editingSchedule) {
                            response = await fetch(`/api/schedules/${this.editingSchedule.id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(formData)
                            });
                        } else {
                            response = await fetch('/api/schedules', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(formData)
                            });
                        }
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            this.showNotification('success', 
                                this.editingSchedule ? 'Расписание обновлено' : 'Расписание создано',
                                result.message);
                            this.closeModal();
                            this.refreshData();
                        } else {
                            this.showNotification('error', 'Ошибка', result.message);
                        }
                    } catch (error) {
                        this.showNotification('error', 'Ошибка', error.message);
                    }
                },

                editSchedule(schedule) {
                    this.editingSchedule = schedule;
                    this.scheduleForm = {
                        name: schedule.name,
                        platform: schedule.platform,
                        schedule_type: schedule.schedule_type,
                        upload_times_str: schedule.upload_times.join(', '),
                        days_of_week: [...schedule.days_of_week],
                        max_videos_per_day: schedule.max_videos_per_day,
                        auto_select_video: schedule.auto_select_video,
                        auto_select_title: schedule.auto_select_title
                    };
                },

                async toggleSchedule(scheduleId) {
                    try {
                        const response = await fetch(`/api/schedules/${scheduleId}/toggle`, {
                            method: 'PATCH'
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            this.showNotification('success', 'Статус изменен', result.message);
                            this.refreshData();
                        } else {
                            this.showNotification('error', 'Ошибка', result.message);
                        }
                    } catch (error) {
                        this.showNotification('error', 'Ошибка', error.message);
                    }
                },

                async deleteSchedule(scheduleId) {
                    if (!confirm('Вы уверены, что хотите удалить это расписание?')) {
                        return;
                    }
                    
                    try {
                        const response = await fetch(`/api/schedules/${scheduleId}`, {
                            method: 'DELETE'
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            this.showNotification('success', 'Расписание удалено', result.message);
                            this.refreshData();
                        } else {
                            this.showNotification('error', 'Ошибка', result.message);
                        }
                    } catch (error) {
                        this.showNotification('error', 'Ошибка', error.message);
                    }
                },

                toggleDay(dayIndex) {
                    const index = this.scheduleForm.days_of_week.indexOf(dayIndex);
                    if (index > -1) {
                        this.scheduleForm.days_of_week.splice(index, 1);
                    } else {
                        this.scheduleForm.days_of_week.push(dayIndex);
                    }
                },

                closeModal() {
                    this.showCreateForm = false;
                    this.editingSchedule = null;
                    this.scheduleForm = {
                        name: '',
                        platform: 'tiktok',
                        schedule_type: 'daily',
                        upload_times_str: '18:00',
                        days_of_week: [0, 1, 2, 3, 4, 5, 6],
                        max_videos_per_day: 5,
                        auto_select_video: true,
                        auto_select_title: true
                    };
                },

                formatDaysOfWeek(days) {
                    if (days.length === 7) {
                        return 'Каждый день';
                    } else if (days.length === 5 && !days.includes(5) && !days.includes(6)) {
                        return 'Будни';
                    } else if (days.length === 2 && days.includes(5) && days.includes(6)) {
                        return 'Выходные';
                    } else {
                        return days.map(d => this.daysOfWeek[d]).join(', ');
                    }
                },

                showNotification(type, title, message) {
                    const notification = { type, title, message, show: true };
                    this.notifications.push(notification);
                    
                    setTimeout(() => {
                        const index = this.notifications.indexOf(notification);
                        if (index > -1) this.removeNotification(index);
                    }, 5000);
                },

                removeNotification(index) {
                    this.notifications.splice(index, 1);
                }
            }
        }
    </script>
</body>
</html>